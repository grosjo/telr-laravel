# :package_description

[![Latest Version on Packagist](https://img.shields.io/packagist/v/melogail/telr-laravel.svg?style=flat-square)](https://packagist.org/packages/melogail/telr-laravel)
[![GitHub Code Style Action Status](https://img.shields.io/github/actions/workflow/status/melogail/telr-laravel/fix-php-code-style-issues.yml?branch=main&label=code%20style&style=flat-square)](https://github.com/melogail/telr-laravel/actions?query=workflow%3A"Fix+PHP+code+style+issues"+branch%3Amain)
[![Total Downloads](https://img.shields.io/packagist/dt/melogail/telr-laravel.svg?style=flat-square)](https://packagist.org/packages/melogail/telr-laravel)

Laravel package to make online payments from your website via ["Telr"](https://telr.com/) payment gateway.

## Installation

You can install the package via composer:

```bash
composer require melogail/telr-laravel
```

You can publish and run the migrations with:

```bash
php artisan vendor:publish --provider="Melogail\TelrLaravel\TelrLaravelServiceProvider" --tag="migrations"
php artisan migrate
```

You can publish the config file with:

```bash
php artisan vendor:publish --provider="Melogail\TelrLaravel\TelrLaravelServiceProvider" --tag="config"
```
This will add the <code>config/telr-laravel.php</code> config file inside your project config folder.

Inside the <code>config/telr-laravel.php</code> config file you will need to add the relative path to success, decline, and cancel page
according to your project route.

```php
return [

    // ...other configs

    'response_path' => [
        'return_auth' => '/:path/to_success_page',
        'return_decl' => '/:path/to_decline_page',
        'return_can' => '/:path/to_cancel_page',
    ],
];
```

Add the following code to your <code>.env</code> file and change the values to your payment values.

```bash
TELR_STORE_ID=      # Payment API key [its different from your "Service API" key].
TELR_AUTH_KEY=      # Payment API key.
TELR_TEST_MODE=     # 1=Test mode | 0=Live mode.
TELR_CURRENCY=      # Currency used for payment.
```

Add <code>TelrLaravel</code> facade inside your <code>config/app.php</code> file.
```php
'aliases' => Facade::defaultAliases()->merge([
        // 'ExampleClass' => App\Example\ExampleClass::class,
        'TelrLaravel' => \Melogail\TelrLaravel\Facades\TelrLaravel::class,

    ])->toArray(),
```

## Usage
To make payment you need to invoke the <code>TelrLaravel</code> class in your controller.
```php
use Melogail\TelrLaravel\TelrLaravel;

$telr_laravel = new TelrLaravel();
```

Use <code>makePayment()</code> method to make payment.
```php
$telr_laravel->makePayment('183-487-143', 9.50, 'Cart generated by John Doe on 2023-1-16');
```
After calling the <code>makePayment()</code> method, then you call for <code>pay()</code> method to perform the payment.

The <code>makePayment(string $order_id, float $amount, string $description)</code> method requires three parameters:
- <code>string $order_id</code> : The order ID generated by your system.
- <code>float $amount</code> : The amount to be paid in decimals ex: 9.50.
- <code>string $description</code> : A short description for the payment, max length 63 characters.

While the <code>pay(<array $params>)</code> method accepts one optional parameter as an array that holds the essential billing information required
by the payment gateway. If these parameters are ignored in your system, the payment gateway page will prompt the user to
add these information.

The required information is as follows:
- <code>fname</code> : The user first name.
- <code>sname</code> : The user sure name.
- <code>bill_addr1</code> : The main billing address.
- <code>bill_phone</code> : The user phone number.
- <code>bill_city</code> : The city, ex: Dubai.
- <code>bill_country</code> : The country, MUST be supplied as a two character ISO 3166 country code, ex: US, GB, EG.
- <code>email</code> : User main email.

```php
$billing_parameters = [
    'fname' => $first_name,
    'sname' => $sure_name,
    'bill_addr1' => $address1,
    'bill_phone' => $phone,
    'bill_city' => $city,
    'bill_country' => $country,
    'email' => $email
];

$telr_laravel->makePayment('183-487-143', 9.50, 'Cart generated by John Doe on 2023-1-16')
    ->pay($billing_parameters);
```

Full code example:
```php
use Melogail\TelrLaravel\TelrLaravel;

$telr_laravel = new TelrLaravel();

$billing_parameters = [
    'fname' => $first_name,
    'sname' => $sure_name,
    'bill_addr1' => $address1,
    'bill_phone' => $phone,
    'bill_city' => $city,
    'bill_country' => $country,
    'email' => $email
];

$telr_laravel->makePayment('183-487-143', 9.50, 'Cart generated by John Doe on 2023-1-16')->pay($billing_parameters);
```

For more information about the billing parameters, check the platform documentation [here](https://telr.com/support/knowledge-base/hosted-payment-page-integration-guide/)

## Confirm Transaction and Update Transaction Status
After setting up payment status path pages inside your <code>config/telr-laravel.php</code> file, you need to create three different views, each for each status (Success, Decline, Cancel).

Inside each view you need to call the <code>setTransactionStatus(Request $request)</code> method on the <code>Telr</code> facade to update the transaction status based on its response return.
```php
use Illuminate\Http\Request;
use \Melogail\TelrLaravel\Facades\TelrLaravel;

class PaymentController extends Controller {

    public function success(Request $request){
    
        // Calling setTransactionStatus facade.
        TelrLaravel::setTransactionStatus($request);
        
        return view( //... success view page);
    }
    
    
    public function decline(Request $request){
    
        // Calling setTransactionStatus facade.
        TelrLaravel::setTransactionStatus($request);
        
        return view( //... decline view page);
    }
    
    
    public function cancel(Request $request){
    
        // Calling setTransactionStatus facade.
        TelrLaravel::setTransactionStatus($request);
        
        return view( //... cancel view page);
    }

}

```


## Changelog

Please see [CHANGELOG](CHANGELOG.md) for more information on what has changed recently.

## Credits

- [Mohamed Elogail](https://github.com/melogail)

## License

The MIT License (MIT). Please see [License File](LICENSE.md) for more information.
